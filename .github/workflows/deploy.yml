name: Deploy Cloudflare Worker
run-name: ðŸš€ Deploy to ${{ github.ref == 'refs/heads/main' && 'Production' || github.ref == 'refs/heads/staging' && 'Staging' || 'Development' }}

on:
  push:
    branches:
      - main
      - staging
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Set environment
        id: env
        run: |
          if [[ ${{ github.ref }} == 'refs/heads/main' ]]; then
            echo "CF_ENV=production" >> $GITHUB_OUTPUT
          elif [[ ${{ github.ref }} == 'refs/heads/staging' ]]; then
            echo "CF_ENV=staging" >> $GITHUB_OUTPUT
          else
            echo "CF_ENV=develop" >> $GITHUB_OUTPUT
          fi

      - name: Install dependencies
        run: bun install

      - name: Build project
        run: CF_ENV=${{ steps.env.outputs.CF_ENV }} bun run build

      - name: Deploy
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: |
            pages functions build --outdir build/worker
            deploy --env ${{ steps.env.outputs.CF_ENV }}

      - name: Post comment on PR
        if: ${{ github.event_name == 'pull_request' && github.event.action == 'opened' }}
        uses: actions/github-script@v6
        with:
          script: |
            const targetBranch = context.payload.pull_request.base.ref;
            let url = '';
            if (targetBranch === 'develop') {
              url = 'https://develop.kotohiro.com';
            } else if (targetBranch === 'staging') {
              url = 'https://staging.kotohiro.com';
            }
            github.rest.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸŽ‰ The application has been deployed to [${url}](${url})!`
            });